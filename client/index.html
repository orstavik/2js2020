<link rel='stylesheet' href='test.css'>
<script src='test.js'></script>
<h1>hello sunshine worker</h1>
<div id="userData">
  <style>
    #login {
      display: block;
    }
    #logout {
      display: none;
    }
    #userData[active] > #login {
      display: none;
    }
    #userData[active] > #logout {
      display: block;
    }
  </style>
  <div id="login">
    <h3>login</h3>
    RememberMe: <input type='checkbox'/><br>
    <a popup href="https://auth.2js.no/login/google">login google</a><br>
    <a popup href="https://auth.2js.no/login/github">login github</a><br>
  </div>
  <div id="logout">
    <pre></pre>
    <a popup href="https://auth.2js.no/logout">logout</a><br>
    <a popup href="https://db.2js.no/SESSION">see the data stored in a cookie on my computer</a>
  </div>
</div>

<script>

  let loginWindow;
  let loginWindowUrl;
  const popupOrigin = 'https://auth.2js.no';

  function receiveLoginData(e) {
    if (e.origin !== popupOrigin || e.source !== loginWindow)            //todo do we need popupOrigin??
      return;
    debugger
    const userEl = document.querySelector('#userData');
    userEl.querySelector('div#logout > pre').innerText = e.data;
    e.data ? userEl.setAttribute('active', 'loggedIn') : userEl.removeAttribute('active');
    debugger
    if(!e.data)
      location = location.href;
  }

  window.addEventListener('message', receiveLoginData);

  for (let link of document.querySelectorAll("a[popup]"))
    link.addEventListener('click', openRequestedSinglePopup);

  function popupParameters() {
    const width = Math.min(600, window.screen.width);
    const height = Math.min(600, window.screen.height);
    const left = window.screen.width / 2 - width / 2;
    const top = window.screen.height / 2 - height / 2;
    return "resizable,scrollbars,status,opener," +
      Object.entries({width, height, left, top}).map(kv => kv.join('=')).join(',');
  }

  function openRequestedSinglePopup(event) {
    event.preventDefault();
    let url = event.currentTarget.href;
    if (document.querySelector('input').checked)
      url += '?remember-me';
    if (!loginWindow || loginWindow.closed) {
      loginWindow = window.open(url, "_blank", popupParameters());
//      loginWindow.onunload = unloadOnMe;//alternative approach to using postMessage. This will require an extra roundtrip to the server
    } else if (loginWindowUrl !== url)
      loginWindow.location = url;
    loginWindowUrl = url;
    loginWindow.focus();
  }
</script>
